<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<meta name="theme-color" content="#111827">

<title>Mobile Database Admin</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- Add these to your <head> section -->
<link rel="stylesheet" href="./static/vendor/codemirror/codemirror.min.css">
<link rel="stylesheet" href="./static/vendor/codemirror/dracula.min.css">

<!---APP CSS--->
<link rel="stylesheet" href="./static/css/sidebar.css">

<link rel="stylesheet" href="./static/css/sql-editor.css">
<!---APP CSS END--->
<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: #0f172a;
  color: #e5e7eb;
  font-size: 13px;
}

/* TOOLBAR */
.table-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px;
  background: #020617;
  position: sticky;
  top: 0;
  z-index: 20;
  flex-wrap: wrap; /* keep for responsiveness */
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 6px;
}

.db-name {
  padding: 5px 12px;
  background: #1e293b;
  border: 1px solid #334155;
  color: #60a5fa;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.db-name:hover {
  background: #334155;
}

.table-select {
  padding: 5px 8px;
  background: #020617;
  border: 1px solid #334155;
  color: #e5e7eb;
  border-radius: 4px;
  min-width: 120px;
}

.table-search {
  padding: 5px 8px;
  background: #020617;
  border: 1px solid #334155;
  color: #e5e7eb;
  border-radius: 4px;
  width: 120px;
}

.table-search::placeholder {
  color: #64748b;
}

.menu-btn {
  padding: 6px 10px;
  background: #1e293b;       /* matches db-name bg */
  border: 1px solid #334155; /* subtle border like other buttons */
  color: #60a5fa;            /* matches db-name text color */
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: background 0.2s, color 0.2s;
}

.menu-btn:hover {
  background: #334155;       /* hover effect like db-name */
  color: #2563eb;            /* slightly brighter on hover */
}

.toolbar-actions {
  display: flex;
  gap: 6px;
}

.toolbar-actions button {
  padding: 6px 8px;
  background: #020617;
  border: 1px solid #334155;
  color: #cbd5f5;
  border-radius: 4px;
  cursor: pointer;
}

.toolbar-actions button:hover {
  color: #60a5fa;
}

.insert-btn {
  padding: 6px 12px;
  background: #2563eb;
  border: none;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}

.row-count {
  margin-left: auto;
  color: #94a3b8;
  font-size: 12px;
}

/* QUERY STATUS BAR */
.query-status {
  padding: 6px 8px;
  background: #1e293b;
  border-bottom: 1px solid #334155;
  color: #94a3b8;
  font-size: 12px;
  display: none;
  position: sticky;
  top: 42px;
  z-index: 18;
}

.query-status.success {
  border-left: 3px solid #22c55e;
  color: #bbf7d0;
}

.query-status.info {
  border-left: 3px solid #3b82f6;
  color: #bfdbfe;
}

/* SELECTION TOOLBAR */
.selection-toolbar {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 8px;
  background: #1e293b;
  position: sticky;
  top: 68px;
  z-index: 19;
  border-bottom: 1px solid #334155;
}

.selection-toolbar button {
  padding: 6px 8px;
  background: #334155;
  border: 1px solid #475569;
  color: #e5e7eb;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.selection-toolbar button:hover {
  background: #475569;
}

.selection-info {
  margin-left: auto;
  color: #94a3b8;
  font-size: 12px;
}

/* TABLE */
.table-wrap {
  /* height: calc(100vh - 42px); */  /* remove this */
  overflow: auto;
}

.db-table {
  width: 100%;
  border-collapse: collapse;
}

.db-table th,
.db-table td {
  padding: 5px 8px;
  border-bottom: 1px solid #1e293b;
  white-space: nowrap;
  text-overflow: clip;
  overflow: visible;
  max-width: 200px;
}

.db-table th {
  background: #020617;
  position: sticky;
  top: 0;
  z-index: 10;
  text-align: left;
}

.db-table th.sortable {
  cursor: pointer;
  user-select: none;
}

.db-table th.sortable:hover {
  background: #1e293b;
}

.db-table th .sort-icon {
  margin-left: 4px;
  color: #64748b;
  font-size: 10px;
}

.db-table tr:hover td {
  background: #020617;
}

.db-table tr.selected-row td {
  background: #1e40af;
}

/* EDITING STYLES */
.editing-cell {
  position: fixed;
  z-index: 1000;
  background: #0f172a;
  border: 2px solid #2563eb;
  border-radius: 4px;
  padding: 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  min-width: 200px;
  max-width: 400px;
}

.cell-edit-input {
  width: 100%;
  background: #0f172a;
  color: #e5e7eb;
  border: none;
  padding: 8px;
  font-family: inherit;
  font-size: 13px;
  outline: none;
}

.cell-edit-textarea {
  width: 100%;
  background: #0f172a;
  color: #e5e7eb;
  border: none;
  padding: 8px;
  font-family: inherit;
  font-size: 13px;
  outline: none;
  resize: vertical;
  min-height: 60px;
  max-height: 200px;
}

.cell-edit-actions {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  padding: 6px 8px;
  background: #1e293b;
  border-top: 1px solid #334155;
}

.cell-edit-btn {
  padding: 4px 8px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  font-size: 11px;
}

.cell-edit-save {
  background: #2563eb;
  color: white;
}

.cell-edit-cancel {
  background: #64748b;
  color: white;
}

/* INLINE EDIT */
td[contenteditable="true"] {
  outline: 1px dashed #2563eb;
  background: #020617;
  white-space: normal;
  overflow: visible;
  z-index: 5;
  position: relative;
}

/* Make sure table columns expand when editing */
.db-table tr td[contenteditable="true"] {
  max-width: none;
}

/* NULL values */
.text-muted {
  color: #9ca3af;
  font-style: italic;
}

/* Checkbox column */
.db-table th:first-child,
.db-table td:first-child {
  width: 40px;
  text-align: center;
  padding-left: 12px;
  padding-right: 12px;
}

.db-table input[type="checkbox"] {
  margin: 0;
  cursor: pointer;
}


.cell-edit-select {
  width: 100%;
  padding: 4px 8px;
  border: 1px solid #4d90fe;
  border-radius: 3px;
  font-family: inherit;
  font-size: inherit;
  background-color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  outline: none;
  cursor: pointer;
}

.cell-edit-select:focus {
  border-color: #1a73e8;
  box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

</style>

</head>

<body>



<!-- MAIN TOOLBAR -->
<div class="table-toolbar">
  <div class="toolbar-left">
    <div class="db-name" onclick="toggleSidebar(this)">
      <i class="fa-solid fa-database"></i>
      <span id="currentDb">mydb</span>
    </div>

    <select class="table-select" id="tableSelect" onchange="switchTable(this.value)">
      <option value="users">users</option>
      <option value="projects">projects</option>
      <option value="payments">payments</option>
      <option value="settings">settings</option>
    </select>

    <input type="text" class="table-search" id="searchInput" placeholder="Search..." oninput="searchTable()">

<button class="menu-btn" onclick="toggleSidebar(this)">
  <i class="fa-solid fa-bars"></i>
</button>

  </div>

  <div class="toolbar-actions">
    <button title="Refresh" onclick="refreshTable()"><i class="fa-solid fa-rotate"></i></button>
    <button title="Structure" onclick="showStructure()"><i class="fa-solid fa-table-columns"></i></button>
    <button title="Truncate" onclick="truncateTable()"><i class="fa-solid fa-trash"></i></button>
    <button title="SQL" onclick="showSqlEditor()"><i class="fa-solid fa-terminal"></i></button>
    <button title="Export All" onclick="exportData()"><i class="fa-solid fa-download"></i></button>
  </div>

  <button class="insert-btn" onclick="showInsert()">
    <i class="fa-solid fa-plus"></i> Insert
  </button>

  <span class="row-count" id="rowCount">Rows: 4</span>
</div>
<!-- QUERY STATUS BAR -->
<div class="query-status" id="queryStatus"></div>

<!-- SELECTION TOOLBAR -->
<div class="selection-toolbar" id="selectionToolbar">
  <button title="Edit selected" onclick="editSelected()"><i class="fa-solid fa-pen"></i> Edit</button>
  <button title="Delete selected" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i> Delete</button>
  <button title="Export selected" onclick="exportSelected()"><i class="fa-solid fa-download"></i> Export</button>
  <button title="Clone selected" onclick="cloneSelected()"><i class="fa-solid fa-copy"></i> Clone</button>
  <span class="selection-info" id="selectionInfo">0 rows selected</span>
</div>



<main id="main-content">
<!-- TABLE -->
<div class="table-wrap">
<table class="db-table" id="dataTable">
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll"></th>
      <th style="min-width:60px">ID</th>
      <th style="min-width:120px">Username</th>
      <th style="min-width:180px">Email</th>
      <th style="min-width:120px">Role</th>
      <th style="min-width:100px">Status</th>
      <th style="min-width:120px">Age</th>
      <th style="min-width:120px">Last Login</th>
      <th style="min-width:90px">Verified</th>
      <th style="min-width:120px">Created</th>
    </tr>
  </thead>

  <tbody id="tableBody">
    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>1</td>
      <td ondblclick="editCell(this)" data-type="string" data-maxlength="50">admin</td>
      <td ondblclick="editCell(this)" data-type="email">admin@site.com</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Owner,Admin,Editor,Viewer,Guest">Owner</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Active,Inactive,Pending,Suspended">Active</td>
      <td class="text-muted" ondblclick="editCell(this)" data-type="number" data-min="18" data-max="100">NULL</td>
      <td class="text-muted">NULL</td>
      <td ondblclick="editCell(this)" data-type="boolean">1</td>
      <td>2024-10-01</td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>2</td>
      <td ondblclick="editCell(this)" data-type="string" data-maxlength="50">lodwick</td>
      <td ondblclick="editCell(this)" data-type="email">lodwick@mail.com</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Owner,Admin,Editor,Viewer,Guest">Admin</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Active,Inactive,Pending,Suspended">Active</td>
      <td ondblclick="editCell(this)" data-type="number" data-min="18" data-max="100">30</td>
      <td>2024-12-11 18:32:10</td>
      <td ondblclick="editCell(this)" data-type="boolean">1</td>
      <td>2024-10-12</td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>3</td>
      <td ondblclick="editCell(this)" data-type="string" data-maxlength="50">jane_doe</td>
      <td ondblclick="editCell(this)" data-type="email">jane@example.com</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Owner,Admin,Editor,Viewer,Guest">Editor</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Active,Inactive,Pending,Suspended">Pending</td>
      <td ondblclick="editCell(this)" data-type="number" data-min="18" data-max="100">25</td>
      <td class="text-muted">NULL</td>
      <td ondblclick="editCell(this)" data-type="boolean">0</td>
      <td>2024-10-15</td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>4</td>
      <td ondblclick="editCell(this)" data-type="string" data-maxlength="50">john_smith</td>
      <td ondblclick="editCell(this)" data-type="email">john@example.com</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Owner,Admin,Editor,Viewer,Guest">Viewer</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Active,Inactive,Pending,Suspended">Suspended</td>
      <td ondblclick="editCell(this)" data-type="number" data-min="18" data-max="100">40</td>
      <td>2024-12-01 09:11:44</td>
      <td ondblclick="editCell(this)" data-type="boolean">0</td>
      <td>2024-10-18</td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>5</td>
      <td ondblclick="editCell(this)" data-type="string" data-maxlength="50">guest_user</td>
      <td class="text-muted" ondblclick="editCell(this)" data-type="email">NULL</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Owner,Admin,Editor,Viewer,Guest">Guest</td>
      <td ondblclick="editCell(this)" data-type="enum" data-options="Active,Inactive,Pending,Suspended">Suspended</td>
      <td class="text-muted" ondblclick="editCell(this)" data-type="number" data-min="18" data-max="100">NULL</td>
      <td class="text-muted">NULL</td>
      <td class="text-muted" ondblclick="editCell(this)" data-type="boolean">NULL</td>
      <td>2024-11-02</td>
    </tr>
  </tbody>
</table>

</div>


<!-- SQL Editor Panel HTML (place before closing </body>) -->
<div class="sql-editor-panel" id="sqlEditorPanel">
  <div style="height:4px; background:#334155;"></div>
  <div class="sql-editor-resize" id="sqlEditorResize"></div>
  <div class="sql-editor-header">
    <h4>
      <i class="fa-solid fa-terminal"></i>
      SQL Editor
    </h4>
    <div class="sql-editor-controls">
      <button class="sql-editor-btn" onclick="insertTemplate('SELECT')" title="Insert SELECT template">
        <i class="fa-solid fa-search"></i>
      </button>
      <button class="sql-editor-btn" onclick="insertTemplate('INSERT')" title="Insert INSERT template">
        <i class="fa-solid fa-plus"></i>
      </button>
      <button class="sql-editor-btn" onclick="insertTemplate('UPDATE')" title="Insert UPDATE template">
        <i class="fa-solid fa-pen"></i>
      </button>
      <button class="sql-editor-btn" onclick="insertTemplate('DELETE')" title="Insert DELETE template">
        <i class="fa-solid fa-trash"></i>
      </button>
      <button class="sql-editor-btn" onclick="clearSqlEditor()" title="Clear editor">
        <i class="fa-solid fa-eraser"></i>
      </button>
      <div style="width: 1px; background: #334155; margin: 0 4px;"></div>
      <button class="sql-editor-btn success" onclick="executeSqlQuery()" title="Execute (Ctrl+Enter)">
        <i class="fa-solid fa-play"></i> Execute
      </button>
      <button class="sql-editor-btn" onclick="toggleSqlEditor()" title="Close editor">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
  </div>
  <div class="sql-editor-body">
    <textarea id="sqlCodeEditor" style="display: none;"></textarea>
  </div>
</div>


</main>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <!-- Header -->
  <div class="sidebar-header">
    <div class="brand">
      <img src="./static/img/logo.png" alt="PHP VCAP Logo">
      <span>PHP VCAP 1.0</span>
    </div>
    <button class="close-btn">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <!-- User Info -->
  <div class="sidebar-user">
    <i class="fa-solid fa-user-shield"></i>
    <div>
      <div class="username">Guest</div>
      <div class="role">Visitor</div>
    </div>
  </div>

  <!-- Sidebar Menu - simple database with tables -->
  <ul class="sidebar-menu" id="sidebar-menu">
    <!-- Database menu item with submenu for tables -->
    <li class="menu-item has-submenu" id="database-item">
      <div class="menu-item-header">
        <i class="fa-solid fa-database"></i>
        <span id="database-name">my_database</span>
        <i class="fa-solid fa-chevron-right submenu-icon"></i>
      </div>
      <ul class="submenu" id="database-tables">
        <!-- Tables will be populated dynamically -->
      </ul>
    </li>

    <!-- Settings menu -->
    <li class="menu-item has-submenu" id="settings-item">
      <div class="menu-item-header">
        <i class="fa-solid fa-cog"></i>
        <span>Settings</span>
        <i class="fa-solid fa-chevron-right submenu-icon"></i>
      </div>
      <ul class="submenu" id="settings-submenu"></ul>
    </li>

    <!-- Example non-submenu item -->
    <li class="menu-item">
      <div class="menu-item-header">
        <i class="fa-solid fa-user"></i>
        <span>Profile</span>
      </div>
    </li>
  </ul>

  <!-- Auth Buttons -->
  <div class="sidebar-footer">
    <button class="btn login-btn">
      <i class="fa-solid fa-right-to-bracket"></i> Login
    </button>
    <button class="btn logout-btn" style="display: none;">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>

<!---EXTERNAL SCRIPTS--->
<script src="./static/vendor/codemirror/codemirror.min.js"></script>
<script src="./static/vendor/codemirror/sql.min.js"></script>
<!---EXTERNAL SCRIPTS--->

<!---APP SCRIPTS--->
<script src="./static/js/console.js"></script>
<script src="./static/js/sql-editor.js?v=1.101"></script>
<script src="./static/js/sidebar.js?v=1"></script>

<!---APP SCRIPTS END--->

<script>
let selectedRows = new Set();
let tableData = [];
let currentSort = { column: 'id', direction: 'asc' };
//let currentDatabase = 'mydb';
let currentTable = 'users';
let queryCounter = 0;
let editingCell = null;

// Initialize table data
function initializeTableData() {
  const rows = document.querySelectorAll('#tableBody tr');
  tableData = Array.from(rows).map(row => ({
    id: row.cells[1].textContent,
    username: row.cells[2].textContent,
    email: row.cells[3].textContent,
    role: row.cells[4].textContent,
    status: row.cells[5].textContent,
    created: row.cells[6].textContent
  }));
}

// Show query status
function showQueryStatus(message, type = 'info', timeTaken = null) {
  const statusBar = document.getElementById('queryStatus');
  let statusMessage = message;
  
  if (type === 'success') {
    queryCounter++;
    if (timeTaken !== null) {
      statusMessage += ` (Query took ${timeTaken} sec)`;
    }
    statusMessage += ` • ${queryCounter} queries executed successfully`;
  }
  
  statusBar.textContent = statusMessage;
  statusBar.className = `query-status ${type}`;
  statusBar.style.display = 'block';
  
  // Auto-hide after 5 seconds for info messages
  if (type === 'info') {
    setTimeout(() => {
      statusBar.style.display = 'none';
    }, 5000);
  }
}
function editCell(cell) {
  const originalText = cell.textContent.trim();
  const type = cell.dataset.type || 'string';

  // Keep your styles
  const originalWhiteSpace = cell.style.whiteSpace;
  const originalOverflow = cell.style.overflow;
  const originalMaxWidth = cell.style.maxWidth;

  // Handle ENUM type with select dropdown
  if (type === 'enum' && cell.dataset.options) {
    const allowedOptions = cell.dataset.options.split(',');
    const currentValue = originalText === 'NULL' ? '' : originalText;
    
    // Create select element
    const select = document.createElement('select');
    select.className = 'cell-edit-select';
    
    // Add empty option for NULL
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = 'NULL';
    select.appendChild(emptyOption);
    
    // Add all enum options
    allowedOptions.forEach(option => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      if (option === currentValue) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });
    
    // Clear cell and add select
    cell.innerHTML = '';
    cell.appendChild(select);
    cell.style.whiteSpace = 'normal';
    cell.style.overflow = 'visible';
    cell.style.maxWidth = 'none';
    
    // Focus and open dropdown
    select.focus();
    
    function saveEnumEdit() {
      const newText = select.value === '' ? 'NULL' : select.value;
      
      cell.contentEditable = false;
      cell.style.whiteSpace = originalWhiteSpace;
      cell.style.overflow = originalOverflow;
      cell.style.maxWidth = originalMaxWidth;
      
      if (newText !== originalText) {
        const start = performance.now();
        cell.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        
        setTimeout(() => {
          const time = ((performance.now() - start) / 1000).toFixed(3);
          cell.textContent = newText;
          cell.classList.toggle('text-muted', newText === 'NULL');
          showQueryStatus('Query OK, 1 row affected', 'success', time);
        }, 500);
      } else {
        cell.textContent = originalText;
      }
      
      cleanupEnum();
    }
    
    function cancelEnumEdit() {
      cell.textContent = originalText;
      cleanupEnum();
    }
    
    function keyHandler(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveEnumEdit();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        cancelEnumEdit();
      }
    }
    
    function cleanupEnum() {
      cell.removeEventListener('blur', saveEnumEdit);
      select.removeEventListener('blur', saveEnumEdit);
      select.removeEventListener('keydown', keyHandler);
    }
    
    // Add event listeners
    select.addEventListener('blur', saveEnumEdit);
    select.addEventListener('keydown', keyHandler);
    
    // Also close on click outside
    cell.addEventListener('blur', saveEnumEdit, { once: true });
    
    return; // Exit early since we handled enum separately
  }
  
  // Original handling for other types
  cell.contentEditable = true;
  cell.style.whiteSpace = 'normal';
  cell.style.overflow = 'visible';
  cell.style.maxWidth = 'none';
  cell.focus();

  // Select all text
  const range = document.createRange();
  range.selectNodeContents(cell);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  function saveEdit() {
    let newText = cell.textContent.trim();

    // TYPE-SPECIFIC HANDLING
    if (type === 'boolean') {
      newText = newText === '1' || newText.toLowerCase() === 'true' ? '1' : '0';
    } else if (type === 'number') {
      let num = parseFloat(newText);
      const min = parseFloat(cell.dataset.min) || -Infinity;
      const max = parseFloat(cell.dataset.max) || Infinity;
      if (isNaN(num)) num = 'NULL';
      else if (num < min) num = min;
      else if (num > max) num = max;
      newText = num.toString();
    } else if (type === 'string' && cell.dataset.maxlength) {
      const max = parseInt(cell.dataset.maxlength);
      if (newText.length > max) newText = newText.slice(0, max);
    } else if (type === 'email') {
      if (newText === '') newText = 'NULL';
      else {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!re.test(newText)) newText = originalText;
      }
    } else if (type === 'null' && newText === '') {
      newText = 'NULL';
    }

    cell.contentEditable = false;
    cell.style.whiteSpace = originalWhiteSpace;
    cell.style.overflow = originalOverflow;
    cell.style.maxWidth = originalMaxWidth;

    if (newText !== originalText) {
      const start = performance.now();
      cell.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

      setTimeout(() => {
        const time = ((performance.now() - start) / 1000).toFixed(3);
        cell.textContent = newText;
        cell.classList.toggle('text-muted', newText === 'NULL');
        showQueryStatus('Query OK, 1 row affected', 'success', time);
      }, 500);
    } else {
      cell.textContent = originalText;
    }

    cleanup();
  }

  function cancelEdit() {
    cell.textContent = originalText;
    cleanup();
  }

  function keyHandler(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveEdit();
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      cancelEdit();
    }
  }

  function cleanup() {
    cell.contentEditable = false;
    cell.style.whiteSpace = originalWhiteSpace;
    cell.style.overflow = originalOverflow;
    cell.style.maxWidth = originalMaxWidth;
    cell.removeEventListener('blur', saveEdit);
    cell.removeEventListener('keydown', keyHandler);
  }

  cell.addEventListener('blur', saveEdit);
  cell.addEventListener('keydown', keyHandler);
}

// Sort table
function sortTable(column) {
  const startTime = performance.now();
  
  const icon = document.getElementById(`sortIcon-${column}`);
  const allIcons = document.querySelectorAll('.sort-icon');
  
  // Reset all icons
  allIcons.forEach(icon => icon.textContent = '');
  
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }
  
  icon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
  sortTableData();
  renderTable();
  
  const endTime = performance.now();
  const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
  
  const visibleRows = document.querySelectorAll('#tableBody tr:not([style*="display: none"])').length;
  const startRow = 1;
  const endRow = visibleRows;
  const totalRows = tableData.length;
  
  showQueryStatus(`Showing rows ${startRow}–${endRow} (${totalRows} total, Query took ${timeTaken} sec)`, 'info');
}

function sortTableData() {
  tableData.sort((a, b) => {
    let valA = a[currentSort.column];
    let valB = b[currentSort.column];
    
    // Handle numeric columns
    if (currentSort.column === 'id') {
      valA = parseInt(valA);
      valB = parseInt(valB);
    }
    
    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  
  tableData.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="row-checkbox" data-id="${row.id}"></td>
      <td>${row.id}</td>
      <td ondblclick="editCell(this)">${row.username}</td>
      <td ondblclick="editCell(this)">${row.email}</td>
      <td ondblclick="editCell(this)">${row.role}</td>
      <td ondblclick="editCell(this)">${row.status}</td>
      <td>${row.created}</td>
    `;
    tbody.appendChild(tr);
  });
  
  updateRowCount();
}

// Search functionality
function searchTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#tableBody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  updateRowCount();
  
  // Show search status
  if (searchTerm) {
    const totalRows = tableData.length;
    showQueryStatus(`Found ${visibleCount} of ${totalRows} rows matching "${searchTerm}"`, 'info');
  }
}

// Select All checkbox functionality
document.getElementById('selectAll').addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('.row-checkbox:not(:disabled)');
  const isChecked = e.target.checked;
  
  checkboxes.forEach(cb => {
    if (cb.closest('tr').style.display !== 'none') {
      cb.checked = isChecked;
      const rowId = cb.getAttribute('data-id');
      const row = cb.closest('tr');
      
      if (isChecked) {
        selectedRows.add(rowId);
        row.classList.add('selected-row');
      } else {
        selectedRows.delete(rowId);
        row.classList.remove('selected-row');
      }
    }
  });
  
  updateSelectionToolbar();
});

// Individual row checkbox functionality
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('row-checkbox')) {
    const rowId = e.target.getAttribute('data-id');
    const row = e.target.closest('tr');
    
    if (e.target.checked) {
      selectedRows.add(rowId);
      row.classList.add('selected-row');
    } else {
      selectedRows.delete(rowId);
      row.classList.remove('selected-row');
      document.getElementById('selectAll').checked = false;
    }
    
    updateSelectionToolbar();
  }
});

// Update selection toolbar
function updateSelectionToolbar() {
  const selectionToolbar = document.getElementById('selectionToolbar');
  const selectionInfo = document.getElementById('selectionInfo');
  
  if (selectedRows.size > 0) {
    selectionToolbar.style.display = 'flex';
    selectionInfo.textContent = selectedRows.size + ' row' + (selectedRows.size !== 1 ? 's' : '') + ' selected';
  } else {
    selectionToolbar.style.display = 'none';
  }
}

// Row count
function updateRowCount() {
  const visibleRows = document.querySelectorAll('#tableBody tr:not([style*="display: none"])').length;
  document.getElementById('rowCount').textContent = `Rows: ${visibleRows}`;
}

function switchDatabase(dbName) {
  currentDatabase = dbName;
  document.getElementById('currentDb').textContent = dbName;
  
  // Update active database in modal
  document.querySelectorAll('.database-item').forEach(item => {
    item.classList.toggle('active', item.textContent === dbName);
  });
  
  
  // Show tables modal after switching database
  setTimeout(() => {
    document.getElementById('tablesModal').style.display = 'flex';
  }, 300);
  
  showQueryStatus(`Database changed to ${dbName}`, 'info');
}


function switchTable(tableName) {
  currentTable = tableName;
  document.getElementById('tableSelect').value = tableName;
  
  // Update active table in modal
  document.querySelectorAll('.table-item').forEach(item => {
    item.classList.toggle('active', item.textContent === tableName);
  });
  
  
  // Simulate loading table data
  showQueryStatus(`Loading table "${tableName}"...`, 'info');
  setTimeout(() => {
    // In a real app, you would fetch data for the new table here
    showQueryStatus(`Table "${tableName}" loaded successfully`, 'info');
  }, 500);
}


function insertNewRow() {
  const username = document.getElementById('newUsername').value;
  const email = document.getElementById('newEmail').value;
  const role = document.getElementById('newRole').value;
  const status = document.getElementById('newStatus').value;
  
  if (!username || !email || !role || !status) {
    showQueryStatus('Error: Please fill all fields', 'info');
    return;
  }
  
  const startTime = performance.now();
  
  const newId = tableData.length > 0 ? Math.max(...tableData.map(r => parseInt(r.id))) + 1 : 1;
  const newRow = {
    id: newId.toString(),
    username,
    email,
    role,
    status,
    created: new Date().toISOString().split('T')[0]
  };
  
  tableData.push(newRow);
  renderTable();
  closeInsertModal();
  
  const endTime = performance.now();
  const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
  
  // Clear form
  document.getElementById('newUsername').value = '';
  document.getElementById('newEmail').value = '';
  document.getElementById('newRole').value = '';
  document.getElementById('newStatus').value = '';
  
  showQueryStatus(`Query OK, 1 row affected`, 'success', timeTaken);
}

// Action functions
function editSelected() {
  if (selectedRows.size === 0) {
    showQueryStatus('Error: Please select rows to edit', 'info');
    return;
  }
  
  const startTime = performance.now();
  setTimeout(() => {
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    showQueryStatus(`Query OK, ${selectedRows.size} rows affected`, 'success', timeTaken);
  }, 600);
}

function deleteSelected() {
  if (selectedRows.size === 0) {
    showQueryStatus('Error: Please select rows to delete', 'info');
    return;
  }
  
  const startTime = performance.now();
  
  if (confirm(`Delete ${selectedRows.size} row(s)? This action cannot be undone.`)) {
    tableData = tableData.filter(row => !selectedRows.has(row.id));
    selectedRows.clear();
    renderTable();
    updateSelectionToolbar();
    
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    showQueryStatus(`Query OK, ${selectedRows.size} rows affected`, 'success', timeTaken);
  }
}

function exportSelected() {
  if (selectedRows.size === 0) {
    showQueryStatus('Error: Please select rows to export', 'info');
    return;
  }
  
  const dataToExport = tableData.filter(row => selectedRows.has(row.id));
  exportToJSON(dataToExport, 'selected_rows.json');
  
  const startTime = performance.now();
  setTimeout(() => {
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    showQueryStatus(`Exported ${selectedRows.size} rows`, 'success', timeTaken);
  }, 300);
}

function cloneSelected() {
  if (selectedRows.size === 0) {
    showQueryStatus('Error: Please select rows to clone', 'info');
    return;
  }
  
  const startTime = performance.now();
  
  const rowsToClone = tableData.filter(row => selectedRows.has(row.id));
  rowsToClone.forEach(row => {
    const newRow = { ...row };
    newRow.id = (Math.max(...tableData.map(r => parseInt(r.id))) + 1).toString();
    newRow.username = row.username + '_copy';
    tableData.push(newRow);
  });
  
  renderTable();
  
  const endTime = performance.now();
  const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
  showQueryStatus(`Query OK, ${selectedRows.size} rows affected`, 'success', timeTaken);
}

function exportData() {
  const startTime = performance.now();
  
  exportToJSON(tableData, 'table_export.json');
  
  setTimeout(() => {
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    showQueryStatus(`Exported ${tableData.length} rows`, 'success', timeTaken);
  }, 300);
}

function exportToJSON(data, filename) {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function refreshTable() {
  const startTime = performance.now();
  
  showQueryStatus('Refreshing table...', 'info');
  
  setTimeout(() => {
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    
    const visibleRows = document.querySelectorAll('#tableBody tr:not([style*="display: none"])').length;
    const totalRows = tableData.length;
    showQueryStatus(`Showing rows 1–${visibleRows} (${totalRows} total, Query took ${timeTaken} sec)`, 'info');
  }, 600);
}

function showStructure() {
  const startTime = performance.now();
  
  const columns = [
    'ID (int) PRIMARY KEY AUTO_INCREMENT',
    'Username (varchar(50)) NOT NULL',
    'Email (varchar(100)) UNIQUE NOT NULL',
    'Role (enum("Owner","Developer","Editor","Viewer")) DEFAULT "Viewer"',
    'Status (enum("Active","Pending","Inactive")) DEFAULT "Pending"',
    'Created (timestamp) DEFAULT CURRENT_TIMESTAMP'
  ];
  
  setTimeout(() => {
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    
    alert('Table Structure:\n\n' + columns.join('\n') + `\n\n(Query took ${timeTaken} sec)`);
    showQueryStatus(`Structure of table "${currentTable}"`, 'info', timeTaken);
  }, 300);
}

function truncateTable() {
  if (confirm('Are you sure you want to truncate the entire table? This cannot be undone.')) {
    const startTime = performance.now();
    
    tableData = [];
    renderTable();
    
    const endTime = performance.now();
    const timeTaken = ((endTime - startTime) / 1000).toFixed(3);
    showQueryStatus(`Query OK, table truncated`, 'success', timeTaken);
  }
}

// Initialize
initializeTableData();
updateRowCount();
updateSelectionToolbar();

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + F for search
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  
  // Escape to clear selection and close modals
  if (e.key === 'Escape') {
    if (editingCell) {
      editingCell.remove();
      editingCell = null;
    }
    
    selectedRows.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row'));
    updateSelectionToolbar();
  }
  
  // Delete key to delete selected
  if (e.key === 'Delete' && selectedRows.size > 0) {
    deleteSelected();
  }
  
  // Ctrl+Enter to execute SQL
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    const sqlModal = document.getElementById('sqlModal');
    if (sqlModal.style.display === 'flex') {
      executeSql();
    }
  }
});
</script>

</body>
</html>